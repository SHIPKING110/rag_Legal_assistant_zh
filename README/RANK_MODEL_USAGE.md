# 📖 Rank模型启用指南

## 快速开始

### 1️⃣ 启动应用
```bash
streamlit run main.py
```

### 2️⃣ 查看设备和内存信息
打开左侧边栏，在"⭐ Rank模型管理"部分可以看到：
- 🖥️ **检测到设备**：显示您的设备类型（GPU或CPU）
- 💾 **可用内存**：显示系统当前可用内存和rank模型所需内存

### 3️⃣ 启用Rank模型（如果内存充足）

#### ✅ 内存充足的情况
- 勾选 "启用Rank重排序模型" 复选框
- 等待系统加载模型（可能需要10-30秒）
- 看到 "✅ Rank模型加载成功" 提示后即可使用
- 后续查询时会自动使用rank模型进行重排序

#### ❌ 内存不足的情况
- "启用Rank重排序模型" 复选框会被禁用（灰显）
- 显示红色警告："⚠️ 内存不足！需要4GB，当前仅XXX GB"
- **解决方案**：
  1. 关闭其他占用内存的应用程序
  2. 重启应用重新检测内存
  3. 或者增加系统内存

## 功能说明

### 设备自动检测

系统会自动检测您的硬件配置：

| 设备类型 | 说明 | 优势 |
|---------|------|------|
| **GPU** | NVIDIA/AMD/Intel等显卡 | ⚡ 推理速度快，10-100倍提升 |
| **CPU** | 处理器 | ✅ 兼容性好，功耗低 |

🎯 **提示**：如果您有GPU，系统会自动使用GPU加速，无需手动配置！

### Rank模型工作流程

```
输入查询
    ↓
基础检索（快速）→ 返回前10条候选文档
    ↓
[如果启用Rank模型]
    ↓
智能重排序 → 返回最相关的前3条文档
    ↓
生成回答
```

### 内存管理机制

```
应用启动
├─ 嵌入模型加载：~2GB
├─ Rank模型初始化：不加载权重（0MB）
│
用户启用Rank
├─ Rank模型加载：~4-6GB
├─ 总内存占用：~6-8GB
│
用户禁用Rank
├─ Rank模型卸载：释放4-6GB
├─ 总内存占用：~2GB（恢复）
```

## 常见问题

### Q1: 什么是Rank模型？
A: Rank（重排序）模型是一个AI模型，用来评估检索出的文档与用户问题的相关度，从而选出最相关的文档。这样可以提高回答的准确性。

### Q2: 为什么Rank模型需要4GB内存？
A: Rank模型（Qwen3-Reranker-0.6B）本身需要约2-3GB内存加载，加上运行时缓冲，共需4GB。

### Q3: 我的内存不足，怎么办？
A: 
- 关闭其他应用程序以释放内存
- 或者暂不启用Rank模型，使用基础检索（准确度会略低）
- 或者升级系统内存

### Q4: 启用Rank模型会变慢吗？
A:
- 首次加载：会多花10-30秒（只有第一次）
- 后续查询：
  - **有GPU**：基本不会变慢（GPU加速）
  - **仅CPU**：会增加5-10秒（对每个查询）

### Q5: Rank模型可以关闭吗？
A: 可以。任何时候都可以取消勾选 "启用Rank重排序模型" 来禁用它，系统会立即释放内存。

### Q6: 多用户同时使用会怎样？
A: 每个用户会加载一份模型副本到内存。例如：
- 1个用户启用：占用6GB
- 2个用户启用：占用12GB
- 建议在高并发场景下禁用Rank模型

## 最佳实践

### 💡 推荐配置

**低端设备（4GB内存）**
- ❌ 不启用Rank模型
- ✅ 使用基础检索功能

**中端设备（8GB内存）**
- ✅ 启用Rank模型
- 🎯 最佳体验

**高端设备（16GB+内存）**
- ✅ 启用Rank模型
- ⚡ 可考虑多用户并发

### 🎯 性能优化建议

1. **首次加载**
   ```
   应用启动 → 检索工作 → 需要高精度时 → 勾选启用Rank
   ```

2. **长期使用**
   ```
   根据内存情况动态调整 → 内存紧张时禁用 → 内存充足时启用
   ```

3. **批量查询**
   ```
   启用Rank模型一次 → 进行多个查询 → 查询完成后禁用
   ```

## 故障排除

### 问题1: 无法启用Rank模型
**症状**：点击复选框没反应或显示错误

**解决方案**：
1. 检查可用内存是否>=4GB
2. 查看浏览器控制台是否有错误信息
3. 重启应用程序
4. 检查rank模型文件是否存在：`./model/rank/Qwen/Qwen3-Reranker-0___6B`

### 问题2: 启用后应用很卡
**症状**：启用Rank后应用响应变慢

**解决方案**：
- 这是CPU加载模型的正常现象
- 等待加载完成（通常10-30秒）
- 如果持续卡顿，检查CPU使用率是否过高
- 建议使用GPU或增加内存

### 问题3: "内存不足"提示
**症状**：显示内存不足，无法启用

**解决方案**：
1. 关闭其他应用程序（浏览器、视频播放器等）
2. 清理系统临时文件
3. 重启计算机
4. 查看任务管理器识别占用内存的应用

## 监控和调试

### 查看实时内存使用情况
```bash
# Windows
tasklist /v

# Mac/Linux
top
```

### 验证GPU支持
```bash
python -c "import torch; print(torch.cuda.is_available())"
```

### 查看可用内存
```bash
python -c "import psutil; print(f'可用内存: {psutil.virtual_memory().available / (1024**3):.2f}GB')"
```

## 反馈与建议

如遇到问题或有改进建议，请：
1. 查看控制台输出的错误信息
2. 记录问题发生的具体步骤
3. 提供系统信息（内存、GPU、Python版本等）
4. 联系开发者或提交Issue

---

**祝您使用愉快！** 🎉
